<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Non-Forfeiture Financial â€” Home</title>
  <style>
    /* ... keep all your existing styles exactly the same ... */
    :root{
      --bg1:#071423;
      --bg2:#0a1a2b;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted: rgba(234,242,255,.72);
      --muted2: rgba(234,242,255,.52);
      --accent:#4fd1c5;
      --accent2:#2dd4bf;
      --danger:#ff5a7a;
      --ok:#22c55e;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(79,209,197,.22), transparent 55%),
        radial-gradient(1200px 700px at 80% 15%, rgba(45,212,191,.18), transparent 55%),
        radial-gradient(900px 600px at 70% 80%, rgba(99,102,241,.16), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100%;
    }

    /* ... ALL YOUR EXISTING CSS ... */
    .topbar{position:sticky;top:0;z-index:10;backdrop-filter:blur(12px);background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.18));border-bottom:1px solid var(--line)}
    .topbar-inner{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px}
    .brand{display:flex;align-items:center;gap:12px;min-width:220px}
    .dot{width:38px;height:38px;border-radius:12px;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.35),rgba(255,255,255,.06) 42%,rgba(79,209,197,.22) 100%),linear-gradient(180deg,rgba(79,209,197,.55),rgba(45,212,191,.12));border:1px solid rgba(255,255,255,.14)}
    .title{font-weight:900;letter-spacing:.2px;line-height:1.05}
    .sub{font-size:12px;color:var(--muted2);margin-top:2px}
    .nav{display:flex;align-items:center;justify-content:flex-end;gap:10px;flex-wrap:wrap}
    .nav a,.nav button{text-decoration:none;color:var(--text);font-weight:900;letter-spacing:.2px;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.18);cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:transform .05s ease,filter .15s ease,border-color .15s ease}
    .nav a.primary{background:linear-gradient(180deg,rgba(79,209,197,.35),rgba(0,0,0,.18));border-color:rgba(79,209,197,.30)}
    .nav a:hover,.nav button:hover{filter:brightness(1.06)}
    .nav a:active,.nav button:active{transform:translateY(1px)}
    .pill{font-family:var(--mono);font-size:12px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.14);color:var(--muted);max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 40px;display:grid;grid-template-columns:1fr;gap:16px}
    .card{background:linear-gradient(180deg,var(--card2),var(--card));border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card .head{padding:16px 16px 12px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .card h2{margin:0;font-size:16px;font-weight:900}
    .card .body{padding:16px}
    .muted{color:var(--muted);font-size:13px;line-height:1.55}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:560px){.grid{grid-template-columns:1fr 1fr}}
    .grid3{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .tile{border:1px solid var(--line);background:rgba(0,0,0,.14);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:6px}
    .tile .k{font-weight:900;font-size:12px;color:var(--muted2);text-transform:uppercase;letter-spacing:.5px}
    .tile .v{font-family:var(--mono);font-size:20px;font-weight:900;color:var(--text)}
    .tile .hint{font-size:11px;color:var(--muted2);margin-top:4px}
    .status-badge{padding:10px 14px;border-radius:12px;font-weight:900;font-size:14px;text-align:center;margin:12px 0}
    .status-badge.ready{background:linear-gradient(180deg,rgba(34,197,94,.25),rgba(34,197,94,.08));border:1px solid rgba(34,197,94,.4);color:rgba(220,255,233,.95)}
    .status-badge.borderline{background:linear-gradient(180deg,rgba(79,209,197,.25),rgba(79,209,197,.08));border:1px solid rgba(79,209,197,.4);color:rgba(220,255,253,.95)}
    .status-badge.wait{background:linear-gradient(180deg,rgba(251,191,36,.25),rgba(251,191,36,.08));border:1px solid rgba(251,191,36,.4);color:rgba(254,252,232,.95)}
    .status-badge.notready{background:linear-gradient(180deg,rgba(255,90,122,.25),rgba(255,90,122,.08));border:1px solid rgba(255,90,122,.4);color:rgba(255,220,228,.95)}
    .status-badge.nodata{background:rgba(0,0,0,.14);border:1px solid var(--line);color:var(--muted)}
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .ctaRow a,.ctaRow button{text-decoration:none;color:var(--text);font-weight:900;padding:12px 16px;border-radius:14px;border:1px solid rgba(79,209,197,.28);background:linear-gradient(180deg,rgba(79,209,197,.35),rgba(0,0,0,.18));display:inline-flex;align-items:center;gap:8px;cursor:pointer;transition:transform .05s ease,filter .15s ease}
    .ctaRow a:hover,.ctaRow button:hover{filter:brightness(1.06)}
    .ctaRow a:active,.ctaRow button:active{transform:translateY(1px)}
    .ctaRow a.secondary,.ctaRow button.secondary{border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--muted)}
    .msg{display:none;padding:12px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.14);color:var(--muted);margin-top:10px}
    .msg.show{display:block}
    .msg.err{border-color:rgba(255,90,122,.35);color:rgba(255,220,228,.92)}
    select{font-family:var(--sans);font-weight:700;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgb(22 26 43);color:var(--text);cursor:pointer;font-size:14px}
    select:focus{outline:none;border-color:var(--accent)}
    .attempts-table{width:100%;border-collapse:collapse;margin-top:12px;font-size:12px}
    .attempts-table th{text-align:left;padding:8px 6px;border-bottom:1px solid var(--line);font-weight:900;color:var(--muted2);font-size:11px;text-transform:uppercase;letter-spacing:.5px}
    .attempts-table td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.04);font-family:var(--mono)}
    .attempts-table tr:hover{background:rgba(255,255,255,.02)}
    .loading{text-align:center;padding:20px;color:var(--muted2);font-size:13px}
  </style>
</head>
<body>
<!-- Auth Loading Overlay -->
<div id="authOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #071423, #0a1a2b); z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column;">
  <div style="text-align: center;">
    <div style="font-size: 48px; margin-bottom: 20px;">ðŸ”’</div>
    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #eaf2ff;">Securing Connection...</div>
    <div id="authStatus" style="font-size: 14px; color: #4fd1c5; min-height: 20px;"></div>
  </div>
</div>

  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Non-Forfeiture Financial</div>
          <div class="sub">Home</div>
        </div>
      </div>

      <div class="nav">
        <span id="userEmail" class="pill">â€”</span>
        <a class="primary" href="exam.html">Exam</a>
        <a class="primary" href="dictionary.html">Dictionary</a>
        <a class="primary" href="caller/leadbase.html">Caller</a>
        <a class="primary" href="refferal.html">Refferal</a>
        <a class="primary" href="pipeline.html">Pipeline</a>
        <a class="primary" href="fcr.html">Register Number</a>
        <button id="btnLogout">Logout</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Phone Number Input (shown only if no phone) -->
    <section id="phoneSection" class="card" style="display:none">
      <div class="head">
        <h2>ðŸ“± Enter Phone Number</h2>
      </div>
      <div class="body">
        <p class="muted" style="margin-bottom:12px">Add your phone number to receive SMS notifications and exam reminders.</p>
        <div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap">
          <input 
            type="tel" 
            id="phoneInput" 
            placeholder="(555) 555-5555"
            style="flex:1;min-width:200px;font-family:var(--sans);font-weight:700;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:rgb(22 26 43);color:var(--text);font-size:14px"
          />
          <button 
            id="savePhoneBtn" 
            onclick="savePhoneNumber()"
            style="padding:12px 20px;border-radius:12px;border:1px solid rgba(79,209,197,.28);background:linear-gradient(180deg,rgba(79,209,197,.35),rgba(0,0,0,.18));color:var(--text);font-weight:900;cursor:pointer;font-size:14px"
          >
            Save Phone Number
          </button>
        </div>
        <div id="phoneMsg" class="msg"></div>
      </div>
    </section>

    <!-- Exam Readiness Dashboard -->
    <section class="card">
      <div class="head">
        <h2>ðŸ“Š Exam Readiness</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="examSelect" style="padding:6px 10px;font-size:12px">
              <option value="MI">Michigan</option>
              <option value="TN">Tennessee</option>
            </select>
            <button id="refreshBtn" class="secondary" style="padding:6px 12px;font-size:12px;border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--muted);border-radius:10px;cursor:pointer;font-weight:900">Refresh</button>
          </div>
      </div>
      <div class="body">
        <div id="readinessContent" class="loading">Loading readiness data...</div>
      </div>
    </section>

    <!-- Quick Actions & State Resources -->
    <section class="card">
      <div class="head">
        <h2>Quick Actions</h2>
      </div>
      <div class="body">
        <div class="ctaRow">
          <a class="primary" href="exam.html">Start Practice Exam</a>
          <a class="primary" href="dictionary.html">Study Dictionary</a>
          <a class="primary" href="caller/leadbase.html">Open Caller</a>
        </div>

        <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--line)">
          <div style="font-weight:900;margin-bottom:10px">ðŸ“š Get Exam Prep Course</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <select id="stateSelect" style="flex:1;min-width:200px">
              <option value="">Select your state...</option>
              <option value="michigan">Michigan</option>
              <option value="tennessee">Tennessee</option>
              <!-- Add all other states... -->
            </select>
            <a id="xcelLink" href="#" target="_blank" style="display:none;padding:10px 16px;text-decoration:none;font-weight:900;border-radius:12px;background:linear-gradient(180deg, rgba(79,209,197,.35), rgba(0,0,0,.18));border:1px solid rgba(79,209,197,.3);color:var(--text)">Get Xcel Course â†’</a>
          </div>
        </div>

        <div id="msg" class="msg"></div>
      </div>
    </section>
  </main>

<!-- Load config and auth FIRST -->
<script src="config.js"></script>
<script src="auth.js"></script>

<script>
  /**********************
   * PAGE-SPECIFIC CODE (NON-AUTH)
   **********************/
  const $ = (id) => document.getElementById(id);

  function setMsg(type, text){
    const el = $("msg");
    el.className = "msg show" + (type === "err" ? " err" : "");
    el.textContent = text || "";
  }
  
  function clearMsg(){
    const el = $("msg");
    el.className = "msg";
    el.textContent = "";
  }

  function updateAuthStatus(message) {
    const statusEl = $('authStatus');
    if (statusEl) statusEl.textContent = message;
  }

  function hideAuthOverlay() {
    const overlay = $('authOverlay');
    if (overlay) {
      overlay.style.opacity = '0';
      overlay.style.transition = 'opacity 0.3s ease';
      setTimeout(() => overlay.style.display = 'none', 300);
    }
  }

  /**********************
   * LOGOUT BUTTON
   **********************/
  $("btnLogout").addEventListener("click", async () => {
    clearMsg();
    const token = Auth.getToken();
    try {
      if (token) { 
        await Auth.apiCall("logout", { token }).catch(()=>{}); 
      }
    } finally {
      Auth.logout();
      window.location.href = "login.html";
    }
  });

  /**********************
   * STATE SELECTOR & XCEL LINK
   **********************/
  const stateSelect = $("stateSelect");
  const xcelLink = $("xcelLink");

  stateSelect.addEventListener("change", () => {
    const state = stateSelect.value;
    if (state) {
      xcelLink.href = `https://partners.xcelsolutions.com/${state}/insurance-license/life?partner=ariasevanson`;
      xcelLink.style.display = "inline-flex";
    } else {
      xcelLink.style.display = "none";
    }
  });

  /**********************
   * PHONE NUMBER MANAGEMENT
   **********************/
  let userHasPhone = false;

  const phoneInput = $("phoneInput");
  if (phoneInput) {
    phoneInput.addEventListener("input", (e) => {
      let value = e.target.value.replace(/\D/g, "");
      if (value.length > 10) value = value.substring(0, 10);
      
      if (value.length >= 6) {
        e.target.value = `(${value.substring(0,3)}) ${value.substring(3,6)}-${value.substring(6)}`;
      } else if (value.length >= 3) {
        e.target.value = `(${value.substring(0,3)}) ${value.substring(3)}`;
      } else {
        e.target.value = value;
      }
    });
  }

  async function checkUserPhone() {
    try {
      const token = Auth.getToken();
      const response = await Auth.apiCall("getUserProfile", { token });
      
      if (response.ok && response.phone && response.phone.trim().length >= 10) {
        userHasPhone = true;
        $("phoneSection").style.display = "none";
      } else {
        userHasPhone = false;
        $("phoneSection").style.display = "block";
      }
    } catch (e) {
      console.log("Phone check not available:", e);
      $("phoneSection").style.display = "none";
    }
  }

  async function savePhoneNumber() {
    const phone = $("phoneInput").value.trim();
    const phoneDigits = phone.replace(/\D/g, "");
    
    if (!phone) {
      showPhoneMsg("Please enter a phone number", "err");
      return;
    }
    
    if (phoneDigits.length < 10) {
      showPhoneMsg("Phone number must be at least 10 digits", "err");
      return;
    }
    
    const btn = $("savePhoneBtn");
    btn.disabled = true;
    btn.textContent = "Saving...";
    
    try {
      const token = Auth.getToken();
      const response = await Auth.apiCall("updatePhone", { token, phone });
      
      if (response.ok) {
        showPhoneMsg("âœ… Phone number saved successfully!", "");
        setTimeout(() => {
          $("phoneSection").style.display = "none";
          userHasPhone = true;
        }, 1500);
      } else {
        throw new Error(response.error || "Failed to save phone");
      }
    } catch (e) {
      console.error("Error saving phone:", e);
      showPhoneMsg("âŒ " + e.message, "err");
      btn.disabled = false;
      btn.textContent = "Save Phone Number";
    }
  }

  function showPhoneMsg(text, type) {
    const msg = $("phoneMsg");
    msg.textContent = text;
    msg.className = "msg show" + (type === "err" ? " err" : "");
    if (!type) {
      setTimeout(() => msg.className = "msg", 3000);
    }
  }

  /**********************
   * READINESS DASHBOARD
   **********************/
  async function loadReadinessData() {
    const exam = $("examSelect").value;
    const contentEl = $("readinessContent");
    
    contentEl.innerHTML = '<div class="loading">Loading readiness data...</div>';
    
    try {
      const data = await Auth.apiCall("getExamMetrics", {
        token: Auth.getToken(),
        exam: exam
      });
      
      if (!data.ok) throw new Error(data.error || "Failed to load");
      
      renderReadiness(data);
    } catch(e) {
      console.error("Failed to load readiness:", e);
      contentEl.innerHTML = `
        <div style="text-align:center;padding:20px;color:var(--muted2)">
          <div style="font-size:16px;margin-bottom:8px">ðŸ“­ No exam data yet</div>
          <div style="font-size:13px">Take a practice exam to see your readiness metrics!</div>
        </div>
      `;
    }
  }

  function renderReadiness(data) {
    // ... keep all your existing renderReadiness code ...
    const contentEl = $("readinessContent");
    const latest = data.latest || {};
    const attempts = data.attempts || [];
    
    const status = latest.readiness_status || "NO DATA";
    let statusClass = "nodata";
    if (status === "READY") statusClass = "ready";
    else if (status === "BORDERLINE") statusClass = "borderline";
    else if (status === "WAIT") statusClass = "wait";
    else if (status.includes("NOT READY")) statusClass = "notready";
    
    const statusExplanations = {
      "READY": "You're ready to pass! Your scores and speed are excellent.",
      "BORDERLINE": "You're close! A bit more practice will get you ready.",
      "WAIT": "Keep practicing. You need higher scores before taking the real exam.",
      "NOT READY (TIME)": "You're too slow. Practice speed to finish within time limits.",
      "NOT READY (DOMAIN)": "Weak domain detected. Study your weakest areas more.",
      "NO DATA": "No exam attempts recorded yet. Take a practice exam to start!"
    };
    
    const explanation = statusExplanations[status] || "Take more practice exams to improve your readiness.";
    
    let html = `<div class="status-badge ${statusClass}">
        <div style="font-size:16px;margin-bottom:4px">${status}</div>
        <div style="font-size:12px;opacity:.85">${explanation}</div>
      </div>`;
    
    // ... rest of your render code ...
    contentEl.innerHTML = html;
  }

  function formatDate(isoString) {
    if (!isoString) return "â€”";
    const d = new Date(isoString);
    const now = new Date();
    const diffMs = now - d;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function getStatusColor(status) {
    if (status === "READY") return "var(--ok)";
    if (status === "BORDERLINE") return "var(--accent)";
    if (status.includes("NOT READY")) return "var(--danger)";
    return "var(--muted2)";
  }

  /**********************
   * PAGE INITIALIZATION - USES AUTH.JS
   **********************/
  (async () => {
    updateAuthStatus("Verifying session...");
    
    // Use Auth.requireAuth() - it handles everything!
    const isAuthenticated = await Auth.requireAuth('login.html');
    
    if (!isAuthenticated) return; // Already redirected to login
    
    try {
      // Get user data from Auth
      const userData = Auth.getUserData();
      $("userEmail").textContent = userData?.email || "â€”";
      
      updateAuthStatus("Loading your data...");
      hideAuthOverlay();
      
      // Check if user has phone number
      await checkUserPhone();
      
      // Load readiness data
      await loadReadinessData();
      
      // Event listeners
      $("examSelect").addEventListener("change", loadReadinessData);
      $("refreshBtn").addEventListener("click", loadReadinessData);
      
    } catch (e) {
      console.error("Error loading home page:", e);
      Auth.logout();
      window.location.href = "login.html";
    }
  })();
</script>
</body>
</html>
