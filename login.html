<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Non-Forfeiture Financial - Login</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 480px;
      background: white;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header {
      background: #003d82;
      color: white;
      padding: 24px;
      text-align: center;
      border-bottom: 3px solid #002a5c;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 12px;
      display: block;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 4px;
    }
    
    .header p {
      font-size: 13px;
      opacity: 0.9;
      font-weight: 400;
    }
    
    .form-section {
      padding: 32px 24px;
    }
    
    .form-section h2 {
      font-size: 16px;
      font-weight: 600;
      color: #003d82;
      margin: 0 0 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .form-group {
      margin-bottom: 18px;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }
    
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      font-size: 14px;
      font-family: inherit;
      background: white;
      transition: border-color 0.2s;
    }
    
    input:focus {
      outline: none;
      border-color: #003d82;
    }
    
    .derived-email {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      font-size: 13px;
      background: #f9f9f9;
      color: #666;
      font-family: 'Courier New', monospace;
    }
    
    .button-group {
      margin-top: 24px;
      display: flex;
      gap: 10px;
    }
    
    button {
      flex: 1;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: background-color 0.2s;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #003d82;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #002a5c;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #555;
      border: 1px solid #ddd;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #e5e5e5;
    }
    
    .message {
      margin-top: 16px;
      padding: 12px;
      font-size: 13px;
      border-left: 3px solid transparent;
      background: #f9f9f9;
      display: none;
    }
    
    .message.show {
      display: block;
    }
    
    .message.success {
      background: #f0f9f4;
      border-color: #10b981;
      color: #065f46;
    }
    
    .message.error {
      background: #fef2f2;
      border-color: #ef4444;
      color: #991b1b;
    }
    
    .hint {
      margin-top: 12px;
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }
    
    .form-section.hidden {
      display: none;
    }
    
    .footer {
      padding: 16px 24px;
      background: #f9f9f9;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      font-size: 12px;
      color: #666;
    }
    
    @media (max-width: 520px) {
      .button-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="logo.png" alt="Non-Forfeiture Financial" class="logo">
      <h1>Non-Forfeiture Financial</h1>
      <p>Secure Account Access</p>
    </div>

    <!-- LOGIN SECTION -->
    <div id="loginSection" class="form-section">
      <h2>Login</h2>
      
      <div class="form-group">
        <label for="loginName">Full Name</label>
        <input type="text" id="loginName" placeholder="First Last" autocomplete="name">
      </div>

      <div class="form-group">
        <label>Derived Email Address</label>
        <div id="loginDerived" class="derived-email">—</div>
      </div>

      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password">
      </div>

      <div class="button-group">
        <button type="button" id="btnLogin" class="btn-primary">Login</button>
      </div>

      <div id="loginMsg" class="message"></div>
    </div>

    <!-- FIRST-TIME SECTION -->
    <div id="firstTimeSection" class="form-section hidden">
      <h2>First-Time Registration</h2>
      
      <div class="form-group">
        <label for="firstName">Full Name</label>
        <input type="text" id="firstName" placeholder="First Last" autocomplete="name" readonly>
      </div>

      <div class="form-group">
        <label>Derived Email Address</label>
        <div id="firstDerived" class="derived-email">—</div>
      </div>

      <div class="form-group">
        <label for="firstPassword">Create Password</label>
        <input type="password" id="firstPassword" placeholder="Create a password (minimum 6 characters)" autocomplete="new-password">
      </div>

      <div class="hint">
        A verification code will be sent to your derived email address: <strong id="firstEmailHint" style="font-family: monospace;">—</strong>
      </div>

      <div class="button-group">
        <button type="button" id="btnSignup" class="btn-primary">Send Verification Code</button>
        <button type="button" id="btnBackToLogin" class="btn-secondary">Back to Login</button>
      </div>

      <div id="firstMsg" class="message"></div>
    </div>

    <!-- VERIFY SECTION -->
    <div id="verifySection" class="form-section hidden">
      <h2>Verify Your Account</h2>
      
      <div class="form-group">
        <label for="verifyName">Full Name</label>
        <input type="text" id="verifyName" readonly>
      </div>

      <div class="form-group">
        <label for="verifyCode">Verification Code</label>
        <input type="text" id="verifyCode" placeholder="Enter 6-digit code" inputmode="numeric" autocomplete="one-time-code" maxlength="6">
      </div>

      <div class="hint">
        Check your email at <strong id="verifyEmailHint" style="font-family: monospace;">—</strong> for the verification code.
      </div>

      <div class="button-group">
        <button type="button" id="btnVerify" class="btn-primary">Verify Code</button>
        <button type="button" id="btnResend" class="btn-secondary">Resend Code</button>
      </div>

      <div id="verifyMsg" class="message"></div>
    </div>

    <div class="footer">
      © 2026 Non-Forfeiture Financial. All rights reserved.
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    /**********************
     * CONFIG
     **********************/
    const API_URL = typeof CFWORKER !== 'undefined' ? CFWORKER : '';

    /**********************
     * ELEMENTS
     **********************/
    const loginSection = document.getElementById('loginSection');
    const firstTimeSection = document.getElementById('firstTimeSection');
    const verifySection = document.getElementById('verifySection');

    const loginName = document.getElementById('loginName');
    const loginPassword = document.getElementById('loginPassword');
    const loginDerived = document.getElementById('loginDerived');
    const loginMsg = document.getElementById('loginMsg');
    const btnLogin = document.getElementById('btnLogin');

    const firstName = document.getElementById('firstName');
    const firstPassword = document.getElementById('firstPassword');
    const firstDerived = document.getElementById('firstDerived');
    const firstEmailHint = document.getElementById('firstEmailHint');
    const firstMsg = document.getElementById('firstMsg');
    const btnSignup = document.getElementById('btnSignup');
    const btnBackToLogin = document.getElementById('btnBackToLogin');

    const verifyName = document.getElementById('verifyName');
    const verifyCode = document.getElementById('verifyCode');
    const verifyEmailHint = document.getElementById('verifyEmailHint');
    const verifyMsg = document.getElementById('verifyMsg');
    const btnVerify = document.getElementById('btnVerify');
    const btnResend = document.getElementById('btnResend');

    const LS_TOKEN = "cc_token";
    const LS_EXPIRES = "cc_expires_at";

    let currentUsername = "";
    let currentEmail = "";
    let currentPassword = "";

    /**********************
     * UTILITIES
     **********************/
    function setCookie(name, value, hours) {
      const expires = new Date();
      expires.setTime(expires.getTime() + hours * 60 * 60 * 1000);
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
    }

    function setSession(token, expiresAt) {
      if (!token) {
        deleteCookie(LS_TOKEN);
        deleteCookie(LS_EXPIRES);
        try {
          localStorage.removeItem(LS_TOKEN);
          localStorage.removeItem(LS_EXPIRES);
        } catch (e) {}
        return;
      }
      
      setCookie(LS_TOKEN, token, 12);
      if (expiresAt) setCookie(LS_EXPIRES, expiresAt, 12);
      
      try {
        localStorage.setItem(LS_TOKEN, token);
        if (expiresAt) localStorage.setItem(LS_EXPIRES, expiresAt);
      } catch (e) {}
    }

    function getToken() {
      const cookieToken = getCookie(LS_TOKEN);
      if (cookieToken) return cookieToken;
      
      try {
        const localToken = localStorage.getItem(LS_TOKEN);
        if (localToken) {
          setCookie(LS_TOKEN, localToken, 12);
          return localToken;
        }
      } catch (e) {}
      return "";
    }

    function normalizeName(raw) {
      return String(raw || "").trim().replace(/\s+/g, " ");
    }

    function derivedEmailFromName(name) {
      const clean = normalizeName(name)
        .toLowerCase()
        .replace(/[^a-z\s]/g, "")
        .replace(/\s+/g, "");
      return clean ? `${clean}.ail@gmail.com` : "";
    }

    function showMessage(el, type, text) {
      el.className = "message show " + (type === "success" ? "success" : "error");
      el.textContent = text || "";
    }

    function clearMessage(el) {
      el.className = "message";
      el.textContent = "";
    }

    function setLoading(btn, loading) {
      btn.disabled = !!loading;
      btn.dataset._old = btn.dataset._old || btn.textContent;
      btn.textContent = loading ? "Please wait..." : btn.dataset._old;
    }

    function showSection(section) {
      loginSection.classList.add('hidden');
      firstTimeSection.classList.add('hidden');
      verifySection.classList.add('hidden');
      
      section.classList.remove('hidden');
      
      clearMessage(loginMsg);
      clearMessage(firstMsg);
      clearMessage(verifyMsg);
    }

    /**********************
     * API
     **********************/
    async function api(action, payload) {
      const res = await fetch(`${API_URL}/${action}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        throw new Error(text || "Invalid response");
      }

      if (!data || data.ok !== true) {
        const err = (data && (data.error || data.detail)) ? 
          (data.error + (data.detail ? ` — ${data.detail}` : "")) : 
          "Request failed";
        throw new Error(err);
      }
      return data;
    }

    /**********************
     * EVENT HANDLERS
     **********************/
    
    // Update derived email as user types
    loginName.addEventListener('input', () => {
      const email = derivedEmailFromName(loginName.value);
      loginDerived.textContent = email || "—";
    });

    // LOGIN
    btnLogin.addEventListener('click', async () => {
      clearMessage(loginMsg);

      const username = normalizeName(loginName.value);
      const password = String(loginPassword.value || "");
      const email = derivedEmailFromName(loginName.value);

      if (!username) {
        showMessage(loginMsg, 'error', 'Please enter your full name.');
        return;
      }
      if (!password) {
        showMessage(loginMsg, 'error', 'Please enter your password.');
        return;
      }

      currentUsername = username;
      currentEmail = email;

      setLoading(btnLogin, true);
      try {
        const out = await api("login", { username, password, email });
        setSession(out.token, out.expires_at);
        showMessage(loginMsg, 'success', 'Login successful. Redirecting...');
        
        await new Promise(resolve => setTimeout(resolve, 500));
        window.location.href = "home.html";

      } catch (e) {
        // If login fails, assume first-time user
        if (e.message.includes("not found") || e.message.includes("Invalid")) {
          // Move to first-time registration
          firstName.value = username;
          firstDerived.textContent = email;
          firstEmailHint.textContent = email;
          
          showSection(firstTimeSection);
          firstPassword.focus();
        } else {
          showMessage(loginMsg, 'error', e.message || "Login failed.");
        }
      } finally {
        setLoading(btnLogin, false);
      }
    });

    // BACK TO LOGIN
    btnBackToLogin.addEventListener('click', () => {
      showSection(loginSection);
      loginPassword.value = '';
      loginName.focus();
    });

    // SIGNUP
    btnSignup.addEventListener('click', async () => {
      clearMessage(firstMsg);

      const username = normalizeName(firstName.value);
      const password = String(firstPassword.value || "");
      const email = firstDerived.textContent;

      if (!username) {
        showMessage(firstMsg, 'error', 'Please enter your full name.');
        return;
      }
      if (password.length < 6) {
        showMessage(firstMsg, 'error', 'Password must be at least 6 characters.');
        return;
      }

      currentUsername = username;
      currentEmail = email;
      currentPassword = password;

      setLoading(btnSignup, true);
      try {
        await api("signup", { username, password, email });
        
        // Move to verify section
        verifyName.value = username;
        verifyEmailHint.textContent = email;
        
        showSection(verifySection);
        showMessage(verifyMsg, 'success', 'Verification code sent to your email.');
        verifyCode.focus();

      } catch (e) {
        showMessage(firstMsg, 'error', e.message || "Registration failed.");
      } finally {
        setLoading(btnSignup, false);
      }
    });

    // RESEND CODE
    btnResend.addEventListener('click', async () => {
      clearMessage(verifyMsg);

      if (!currentUsername || !currentPassword || !currentEmail) {
        showMessage(verifyMsg, 'error', 'Session expired. Please start over.');
        return;
      }

      setLoading(btnResend, true);
      try {
        await api("signup", { 
          username: currentUsername, 
          password: currentPassword, 
          email: currentEmail 
        });
        showMessage(verifyMsg, 'success', 'Verification code resent.');
      } catch (e) {
        showMessage(verifyMsg, 'error', e.message || "Resend failed.");
      } finally {
        setLoading(btnResend, false);
      }
    });

    // VERIFY
    btnVerify.addEventListener('click', async () => {
      clearMessage(verifyMsg);

      const username = currentUsername;
      const code = String(verifyCode.value || "").trim();
      const email = currentEmail;

      if (!username) {
        showMessage(verifyMsg, 'error', 'Session expired. Please start over.');
        return;
      }
      if (!/^\d{6}$/.test(code)) {
        showMessage(verifyMsg, 'error', 'Please enter a valid 6-digit code.');
        return;
      }

      setLoading(btnVerify, true);
      try {
        await api("verify", { username, code, email });
        showMessage(verifyMsg, 'success', 'Account verified! Redirecting to login...');
        
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Return to login with pre-filled name
        loginName.value = username;
        loginDerived.textContent = email;
        loginPassword.value = '';
        
        showSection(loginSection);
        showMessage(loginMsg, 'success', 'Account verified! Please login.');
        loginPassword.focus();

      } catch (e) {
        showMessage(verifyMsg, 'error', e.message || "Verification failed.");
      } finally {
        setLoading(btnVerify, false);
      }
    });

    // Check if already logged in
    (async () => {
      const token = getToken();
      if (token) {
        try {
          await api("me", { token });
          window.location.href = "home.html";
        } catch (e) {
          setSession("", "");
        }
      }
    })();
  </script>
</body>
</html>
