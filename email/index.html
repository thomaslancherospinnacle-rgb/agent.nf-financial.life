<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email - American Income Life</title>
  
  <script src="../config.js"></script>
  <script src="../auth.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
    }
    
    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .hamburger {
      display: none;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .hamburger:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .hamburger span {
      width: 24px;
      height: 3px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s;
    }
    
    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg) translate(6px, 6px);
    }
    
    .hamburger.active span:nth-child(2) {
      opacity: 0;
    }
    
    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }
    
    .header h1 {
      font-size: 24px;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .user-email {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .compose-btn, .refresh-btn {
      padding: 10px 20px;
      background: white;
      color: #1e3a8a;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      font-size: 14px;
    }
    
    .refresh-btn {
      padding: 10px 16px;
    }
    
    .compose-btn:hover, .refresh-btn:hover {
      transform: translateY(-2px);
    }
    
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .sidebar {
      width: 240px;
      background: #f9fafb;
      border-right: 1px solid #e5e7eb;
      padding: 20px;
      overflow-y: auto;
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }
    
    .nav-section {
      margin-bottom: 24px;
    }
    
    .nav-section-title {
      font-size: 11px;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding: 0 12px;
    }
    
    .nav-item {
      padding: 12px 16px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    
    .nav-item:hover {
      background: #e5e7eb;
    }
    
    .nav-item.active {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .nav-item-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-badge {
      background: #ef4444;
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 12px;
      min-width: 20px;
      text-align: center;
    }
    
    .email-list-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .email-toolbar {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 200px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 10px 40px 10px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border 0.2s;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }
    
    .toolbar-btn {
      padding: 8px 14px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .toolbar-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
    
    .email-list {
      flex: 1;
      overflow-y: auto;
    }
    
    .email-item {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }
    
    .email-item:hover {
      background: #f9fafb;
    }
    
    .email-item.unread {
      background: #eff6ff;
    }
    
    .email-item.unread .email-from,
    .email-item.unread .email-subject {
      font-weight: 700;
    }
    
    .email-item.selected {
      background: #dbeafe;
    }
    
    .email-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    
    .email-from {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }
    
    .email-date {
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
    }
    
    .email-subject {
      color: #374151;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .email-snippet {
      font-size: 13px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .email-tags {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    
    .email-tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      background: #e0e7ff;
      color: #3730a3;
      font-weight: 600;
    }
    
    .email-viewer {
      flex: 1;
      display: none;
      flex-direction: column;
      border-left: 1px solid #e5e7eb;
      background: white;
    }
    
    .email-viewer.active {
      display: flex;
    }
    
    .email-viewer-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .email-viewer-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .viewer-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .viewer-btn:hover {
      background: #f3f4f6;
    }
    
    .viewer-btn.primary {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .viewer-btn.primary:hover {
      background: #2563eb;
    }
    
    .email-viewer-subject {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 12px;
    }
    
    .email-viewer-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #6b7280;
      font-size: 14px;
    }
    
    .email-viewer-from {
      font-weight: 600;
      color: #1f2937;
    }
    
    .email-viewer-body {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      line-height: 1.6;
    }
    
    .email-viewer-body img {
      max-width: 100%;
      height: auto;
    }
    
    .email-attachments {
      padding: 20px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    
    .attachment-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    .attachment-icon {
      width: 40px;
      height: 40px;
      background: #dbeafe;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .attachment-info {
      flex: 1;
    }
    
    .attachment-name {
      font-weight: 600;
      font-size: 14px;
      color: #1f2937;
    }
    
    .attachment-size {
      font-size: 12px;
      color: #6b7280;
    }
    
    .attachment-download {
      padding: 6px 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 8px;
      color: #374151;
    }
    
    .compose-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .compose-modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }
    
    .modal-header {
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .modal-header h2 {
      font-size: 20px;
    }
    
    .modal-header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .save-draft-btn {
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .save-draft-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .close-modal {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .close-modal:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .modal-body {
      padding: 0;
      overflow-y: auto;
      flex: 1;
    }
    
    .form-group {
      padding: 0 30px;
      margin-bottom: 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .form-group label {
      font-weight: 600;
      color: #374151;
      font-size: 13px;
      display: inline-block;
      width: 60px;
      padding: 16px 0;
    }
    
    .form-group input {
      border: none;
      padding: 16px 0;
      font-size: 14px;
      flex: 1;
      outline: none;
      width: calc(100% - 70px);
    }
    
    .recipient-container {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      width: calc(100% - 70px);
      padding: 12px 0;
    }
    
    .email-chip {
      background: #dbeafe;
      color: #1e40af;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .email-chip .remove {
      cursor: pointer;
      font-weight: bold;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .email-chip .remove:hover {
      opacity: 1;
    }
    
    .chip-input {
      border: none !important;
      padding: 4px !important;
      flex: 1;
      min-width: 120px;
      outline: none;
    }
    
    .cc-bcc-toggle {
      color: #3b82f6;
      font-size: 13px;
      cursor: pointer;
      padding: 12px 0;
      font-weight: 500;
    }
    
    .cc-bcc-toggle:hover {
      text-decoration: underline;
    }
    
    .editor-toolbar {
      padding: 12px 30px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .toolbar-btn {
      padding: 8px 12px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .toolbar-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    
    .toolbar-btn.active {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }
    
    .toolbar-separator {
      width: 1px;
      height: 24px;
      background: #d1d5db;
      margin: 0 4px;
    }
    
    .preset-btn {
      position: relative;
    }
    
    .preset-menu {
      position: fixed;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 1001;
      display: none;
    }
    
    .preset-menu.active {
      display: block;
    }
    
    .preset-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .preset-item:last-child {
      border-bottom: none;
    }
    
    .preset-item:hover {
      background: #f3f4f6;
    }
    
    .preset-item strong {
      display: block;
      color: #1f2937;
      margin-bottom: 2px;
    }
    
    .preset-item span {
      font-size: 12px;
      color: #6b7280;
    }
    
    .color-picker {
      position: fixed;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      padding: 12px;
      z-index: 1001;
      display: none;
    }
    
    .color-picker.active {
      display: block;
    }
    
    .color-grid {
      display: grid;
      grid-template-columns: repeat(8, 28px);
      gap: 6px;
    }
    
    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .color-swatch:hover {
      border-color: #6b7280;
      transform: scale(1.1);
    }
    
    #bodyEditor {
      min-height: 300px;
      padding: 24px 30px;
      outline: none;
      font-size: 14px;
      line-height: 1.6;
      color: #1f2937;
    }
    
    #bodyEditor:empty:before {
      content: 'Compose your email...';
      color: #9ca3af;
    }
    
    .signature-section {
      border-top: 1px solid #e5e7eb;
      padding: 20px 30px;
      background: #f9fafb;
    }
    
    .signature-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    #signaturePreview {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }
    
    .attachment-section {
      padding: 16px 30px;
      border-top: 1px solid #e5e7eb;
      background: #fafafa;
    }
    
    .attachment-upload {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .attachment-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .attachment-btn:hover {
      background: #f3f4f6;
    }
    
    .attachment-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .attached-file {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
    }
    
    .attached-file-icon {
      width: 32px;
      height: 32px;
      background: #dbeafe;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .attached-file-info {
      flex: 1;
    }
    
    .attached-file-name {
      font-size: 13px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .attached-file-size {
      font-size: 11px;
      color: #6b7280;
    }
    
    .remove-attachment {
      cursor: pointer;
      color: #ef4444;
      font-size: 18px;
      padding: 4px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .remove-attachment:hover {
      background: #fee2e2;
    }
    
    .modal-footer {
      padding: 20px 30px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .schedule-options {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .schedule-btn {
      padding: 8px 14px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .schedule-btn:hover {
      background: #f3f4f6;
    }
    
    #sendBtn {
      padding: 12px 32px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #sendBtn:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }
    
    #sendBtn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    .status {
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 500;
      text-align: center;
      margin: 16px 30px;
    }
    
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    
    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .pagination button {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .pagination button:hover:not(:disabled) {
      background: #f3f4f6;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination span {
      font-size: 13px;
      color: #6b7280;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 0;
      }
      
      .container {
        border-radius: 0;
        height: 100vh;
      }
      
      .hamburger {
        display: flex;
      }
      
      .header h1 {
        font-size: 18px;
      }
      
      .user-email {
        display: none;
      }
      
      .compose-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .refresh-btn {
        padding: 8px;
      }
      
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 999;
        transform: translateX(-100%);
        width: 280px;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 998;
      }
      
      .sidebar-overlay.active {
        display: block;
      }
      
      .email-list-container {
        width: 100%;
      }
      
      .email-viewer {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 997;
        border-left: none;
      }
      
      .email-toolbar {
        flex-direction: column;
        gap: 8px;
      }
      
      .search-box {
        width: 100%;
      }
      
      .modal-content {
        max-width: 100%;
        max-height: 100vh;
        border-radius: 0;
      }
      
      .editor-toolbar {
        overflow-x: auto;
        flex-wrap: nowrap;
      }
      
      #bodyEditor {
        min-height: 200px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 15px 20px;
      }
      
      .email-item {
        padding: 12px 16px;
      }
      
      .form-group {
        padding: 0 20px;
      }
      
      #bodyEditor {
        padding: 20px;
      }
      
      .modal-footer {
        flex-direction: column;
        gap: 12px;
      }
      
      .schedule-options {
        width: 100%;
        justify-content: center;
      }
      
      #sendBtn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="hamburger" id="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <h1>üìß Email Center</h1>
      </div>
      <div class="header-actions">
        <span class="user-email" id="userEmail">Loading...</span>
        <button class="refresh-btn" onclick="refreshEmails()">üîÑ Refresh</button>
        <button class="compose-btn" onclick="openCompose()">‚úâÔ∏è Compose</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="nav-section">
          <div class="nav-section-title">Mail</div>
          <div class="nav-item active" onclick="switchView('inbox')">
            <div class="nav-item-left">
              <span>üì•</span>
              <span>Inbox</span>
            </div>
            <span class="nav-badge" id="inboxBadge">0</span>
          </div>
          <div class="nav-item" onclick="switchView('sent')">
            <div class="nav-item-left">
              <span>üì§</span>
              <span>Sent</span>
            </div>
          </div>
          <div class="nav-item" onclick="switchView('drafts')">
            <div class="nav-item-left">
              <span>üìù</span>
              <span>Drafts</span>
            </div>
            <span class="nav-badge" id="draftsBadge" style="background: #f59e0b;">0</span>
          </div>
          <div class="nav-item" onclick="switchView('starred')">
            <div class="nav-item-left">
              <span>‚≠ê</span>
              <span>Starred</span>
            </div>
          </div>
          <div class="nav-item" onclick="switchView('archive')">
            <div class="nav-item-left">
              <span>üì¶</span>
              <span>Archive</span>
            </div>
          </div>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Labels</div>
          <div class="nav-item" onclick="switchView('label-important')">
            <div class="nav-item-left">
              <span>üî¥</span>
              <span>Important</span>
            </div>
          </div>
          <div class="nav-item" onclick="switchView('label-work')">
            <div class="nav-item-left">
              <span>üíº</span>
              <span>Work</span>
            </div>
          </div>
          <div class="nav-item" onclick="switchView('label-personal')">
            <div class="nav-item-left">
              <span>üë§</span>
              <span>Personal</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar Overlay for Mobile -->
      <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

      <!-- Email List -->
      <div class="email-list-container" id="emailListContainer">
        <div class="email-toolbar">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search emails..." oninput="searchEmails()">
            <span class="search-icon">üîç</span>
          </div>
          <button class="toolbar-btn" onclick="markAsRead()">Mark as Read</button>
          <button class="toolbar-btn" onclick="deleteSelected()">üóëÔ∏è Delete</button>
        </div>
        
        <div class="email-list" id="emailList">
          <div class="loading">Loading emails...</div>
        </div>
        
        <div class="pagination" id="pagination" style="display: none;">
          <button onclick="previousPage()">‚Üê Previous</button>
          <span id="pageInfo">Page 1</span>
          <button onclick="nextPage()">Next ‚Üí</button>
        </div>
      </div>

      <!-- Email Viewer -->
      <div class="email-viewer" id="emailViewer">
        <div class="email-viewer-header">
          <div class="email-viewer-actions">
            <button class="viewer-btn" onclick="closeEmailViewer()">‚Üê Back</button>
            <button class="viewer-btn primary" onclick="replyToEmail()">‚Ü©Ô∏è Reply</button>
            <button class="viewer-btn" onclick="forwardEmail()">‚û°Ô∏è Forward</button>
            <button class="viewer-btn" onclick="starEmail()">‚≠ê Star</button>
            <button class="viewer-btn" onclick="archiveEmail()">üì¶ Archive</button>
            <button class="viewer-btn" onclick="deleteEmail()">üóëÔ∏è Delete</button>
          </div>
          <h2 class="email-viewer-subject" id="viewerSubject">Email Subject</h2>
          <div class="email-viewer-meta">
            <span class="email-viewer-from" id="viewerFrom">from@example.com</span>
            <span>‚Ä¢</span>
            <span id="viewerDate">Jan 1, 2025</span>
            <span>‚Ä¢</span>
            <span id="viewerTo">To: you@example.com</span>
          </div>
        </div>
        <div class="email-viewer-body" id="viewerBody">
          <p>Email content will appear here...</p>
        </div>
        <div class="email-attachments" id="viewerAttachments" style="display: none;">
          <h3 style="margin-bottom: 12px; font-size: 14px; color: #6b7280;">Attachments</h3>
          <div id="attachmentsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compose Modal -->
  <div class="compose-modal" id="composeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">New Message</h2>
        <div class="modal-header-actions">
          <button class="save-draft-btn" onclick="saveDraft()">üíæ Save Draft</button>
          <button class="close-modal" onclick="closeCompose()">√ó</button>
        </div>
      </div>
      
      <div class="modal-body">
        <!-- Recipients -->
        <div class="form-group">
          <label>To:</label>
          <div class="recipient-container" id="toContainer">
            <input type="email" class="chip-input" id="toInput" placeholder="Add recipient..." onkeydown="handleRecipientInput(event, 'to')">
          </div>
        </div>
        
        <div class="form-group" id="ccGroup" style="display: none;">
          <label>Cc:</label>
          <div class="recipient-container" id="ccContainer">
            <input type="email" class="chip-input" id="ccInput" placeholder="Add CC..." onkeydown="handleRecipientInput(event, 'cc')">
          </div>
        </div>
        
        <div class="form-group" id="bccGroup" style="display: none;">
          <label>Bcc:</label>
          <div class="recipient-container" id="bccContainer">
            <input type="email" class="chip-input" id="bccInput" placeholder="Add BCC..." onkeydown="handleRecipientInput(event, 'bcc')">
          </div>
        </div>
        
        <div class="form-group" style="padding: 0 30px;">
          <span class="cc-bcc-toggle" onclick="toggleCcBcc()">+ Add Cc/Bcc</span>
        </div>
        
        <!-- Subject -->
        <div class="form-group">
          <label>Subject:</label>
          <input type="text" id="subject" placeholder="Email subject...">
        </div>
        
        <!-- Editor Toolbar -->
        <div class="editor-toolbar">
          <button class="toolbar-btn" onclick="formatText('bold')" title="Bold (Ctrl+B)"><strong>B</strong></button>
          <button class="toolbar-btn" onclick="formatText('italic')" title="Italic (Ctrl+I)"><em>I</em></button>
          <button class="toolbar-btn" onclick="formatText('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
          <div class="toolbar-separator"></div>
          <button class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
          <button class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
          <div class="toolbar-separator"></div>
          <button class="toolbar-btn" onclick="insertLink()" title="Insert Link">üîó Link</button>
          <button class="toolbar-btn" onclick="toggleColorPicker('text', event)" title="Text Color">üé® Color</button>
          <div class="toolbar-separator"></div>
          <button class="toolbar-btn preset-btn" onclick="togglePresetMenu(event)" title="Insert Template">üìÑ Templates</button>
        </div>
        
        <!-- Color Picker -->
        <div class="color-picker" id="colorPicker">
          <div class="color-grid">
            <div class="color-swatch" style="background: #000000;" onclick="applyColor('#000000')"></div>
            <div class="color-swatch" style="background: #ef4444;" onclick="applyColor('#ef4444')"></div>
            <div class="color-swatch" style="background: #f59e0b;" onclick="applyColor('#f59e0b')"></div>
            <div class="color-swatch" style="background: #10b981;" onclick="applyColor('#10b981')"></div>
            <div class="color-swatch" style="background: #3b82f6;" onclick="applyColor('#3b82f6')"></div>
            <div class="color-swatch" style="background: #8b5cf6;" onclick="applyColor('#8b5cf6')"></div>
            <div class="color-swatch" style="background: #ec4899;" onclick="applyColor('#ec4899')"></div>
            <div class="color-swatch" style="background: #6b7280;" onclick="applyColor('#6b7280')"></div>
          </div>
        </div>
        
        <!-- Preset Menu -->
        <div class="preset-menu" id="presetMenu">
          <div class="preset-item" onclick="insertChildSafeKit()">
            <strong>Child Safe Kit</strong>
            <span>App download links and info</span>
          </div>
          <div class="preset-item" onclick="insertWillKit()">
            <strong>Will Kit</strong>
            <span>Estate planning guide (with PDF)</span>
          </div>
          <div class="preset-item" onclick="insertFollowUp()">
            <strong>Follow-Up</strong>
            <span>Professional follow-up template</span>
          </div>
          <div class="preset-item" onclick="insertMeeting()">
            <strong>Meeting Invite</strong>
            <span>Schedule a meeting template</span>
          </div>
        </div>
        
        <!-- Body Editor -->
        <div id="bodyEditor" contenteditable="true"></div>
        
        <!-- Signature -->
        <div class="signature-section">
          <div class="signature-label">SIGNATURE:</div>
          <div id="signaturePreview">
            <p>Best regards,<br>
            <strong id="signatureName">Your Name</strong><br>
            American Income Life<br>
            üìû <span id="signaturePhone">(555) 123-4567</span><br>
            üìß <span id="signatureEmail">your.email@example.com</span></p>
          </div>
        </div>
        
        <!-- Attachments -->
        <div class="attachment-section">
          <div class="attachment-upload">
            <input type="file" id="fileInput" style="display: none;" multiple onchange="handleFileUpload()">
            <button class="attachment-btn" onclick="document.getElementById('fileInput').click()">
              üìé Attach Files
            </button>
            <span style="font-size: 12px; color: #6b7280;">Max 10MB per file</span>
          </div>
          <div class="attachment-list" id="attachmentList"></div>
        </div>
        
        <div id="composeStatus" class="status" style="display: none;"></div>
      </div>
      
      <div class="modal-footer">
        <div class="schedule-options">
          <button class="schedule-btn" onclick="scheduleEmail()">üïê Schedule Send</button>
        </div>
        <button id="sendBtn" onclick="sendEmail()">Send Email</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentView = 'inbox';
    let toEmails = [];
    let ccEmails = [];
    let bccEmails = [];
    let attachments = [];
    let currentColorType = 'text';
    let allEmails = [];
    let currentPage = 1;
    let emailsPerPage = 20;
    let selectedEmail = null;
    let currentDraftId = null;

    // Initialize
    window.onload = async function() {
      console.log('Email interface loading...');
      currentUser = await checkAuth();
      
      if (currentUser) {
        console.log('User authenticated:', currentUser);
        
        // Fetch full user data from /me endpoint
        try {
          const meResponse = await fetch(CFWORKER + '/me', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (meResponse.ok) {
            const userData = await meResponse.json();
            if (userData.ok && userData.user) {
              // Merge /me data into currentUser
              currentUser = { ...currentUser, ...userData.user };
              console.log('User data loaded from /me:', currentUser);
            }
          }
        } catch (error) {
          console.error('Error loading user data from /me:', error);
        }
        
        document.getElementById('userEmail').textContent = currentUser.email || currentUser.username;
        
        // Update signature with full user data
        updateSignature();
        
        // Load emails
        loadEmails();
        
        // Load drafts count
        loadDraftsCount();
      }
    };

    // Update signature with user info
    function updateSignature() {
      if (!currentUser) {
        console.error('updateSignature called but currentUser is null');
        return;
      }
      
      const name = currentUser.fullName || currentUser.firstName || currentUser.username || 'Agent';
      const email = currentUser.email || 'agent@americanincome.life';
      const phone = currentUser.phone || currentUser.phoneNumber || '(555) 123-4567';
      
      document.getElementById('signatureName').textContent = name;
      document.getElementById('signatureEmail').textContent = email;
      document.getElementById('signaturePhone').textContent = phone;
    }

    // Toggle sidebar on mobile
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const hamburger = document.getElementById('hamburger');
      
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
      hamburger.classList.toggle('active');
    }

    document.getElementById('hamburger').addEventListener('click', toggleSidebar);

    // Switch view
    function switchView(view) {
      currentView = view;
      currentPage = 1;
      
      // Update active nav item
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.nav-item').classList.add('active');
      
      // Close sidebar on mobile
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
      
      // Close email viewer
      closeEmailViewer();
      
      // Load emails for this view
      loadEmails();
    }

    // Load emails
    async function loadEmails() {
      const emailList = document.getElementById('emailList');
      emailList.innerHTML = '<div class="loading">Loading emails...</div>';
      
      // Safety check
      if (!currentUser) {
        console.error('loadEmails called but currentUser is null');
        emailList.innerHTML = `
          <div class="empty-state">
            <h3>‚ö†Ô∏è Not authenticated</h3>
            <p>Please log in to view your emails.</p>
          </div>
        `;
        return;
      }
      
      try {
        const response = await fetch(CFWORKER + '/email/list', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username || currentUser.email.split('@')[0],
            folder: currentView,
            page: currentPage,
            perPage: emailsPerPage
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          allEmails = data.emails || [];
          displayEmails(allEmails);
          updateInboxBadge(data.unreadCount || 0);
        } else {
          // Show empty state for now (emails not implemented yet)
          emailList.innerHTML = `
            <div class="empty-state">
              <h3>üì≠ No emails yet</h3>
              <p>Your ${currentView} is empty. Start by composing a new email!</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Load emails error:', error);
        emailList.innerHTML = `
          <div class="empty-state">
            <h3>üì≠ No emails yet</h3>
            <p>Your ${currentView} is empty. Start by composing a new email!</p>
          </div>
        `;
      }
    }

    // Display emails
    function displayEmails(emails) {
      const emailList = document.getElementById('emailList');
      
      if (emails.length === 0) {
        emailList.innerHTML = `
          <div class="empty-state">
            <h3>üì≠ No emails</h3>
            <p>No emails found in ${currentView}.</p>
          </div>
        `;
        return;
      }
      
      emailList.innerHTML = emails.map((email, index) => `
        <div class="email-item ${email.unread ? 'unread' : ''}" onclick="openEmail(${index})">
          <div class="email-item-header">
            <div class="email-from">${escapeHtml(email.from)}</div>
            <div class="email-date">${formatDate(email.date)}</div>
          </div>
          <div class="email-subject">${escapeHtml(email.subject)}</div>
          <div class="email-snippet">${escapeHtml(email.snippet || '')}</div>
          ${email.labels ? `
            <div class="email-tags">
              ${email.labels.map(label => `<span class="email-tag">${label}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `).join('');
      
      // Show/hide pagination
      updatePagination(emails.length);
    }

    // Open email in viewer
    function openEmail(index) {
      selectedEmail = allEmails[index];
      
      if (!selectedEmail) return;
      
      // Populate viewer
      document.getElementById('viewerSubject').textContent = selectedEmail.subject;
      document.getElementById('viewerFrom').textContent = selectedEmail.from;
      document.getElementById('viewerDate').textContent = formatDate(selectedEmail.date);
      document.getElementById('viewerTo').textContent = 'To: ' + (selectedEmail.to || 'me');
      document.getElementById('viewerBody').innerHTML = selectedEmail.body || '<p>No content</p>';
      
      // Handle attachments
      if (selectedEmail.attachments && selectedEmail.attachments.length > 0) {
        document.getElementById('viewerAttachments').style.display = 'block';
        document.getElementById('attachmentsList').innerHTML = selectedEmail.attachments.map(att => `
          <div class="attachment-item">
            <div class="attachment-icon">üìÑ</div>
            <div class="attachment-info">
              <div class="attachment-name">${escapeHtml(att.name)}</div>
              <div class="attachment-size">${formatFileSize(att.size)}</div>
            </div>
            <button class="attachment-download" onclick="downloadAttachment('${att.id}')">Download</button>
          </div>
        `).join('');
      } else {
        document.getElementById('viewerAttachments').style.display = 'none';
      }
      
      // Show viewer
      document.getElementById('emailViewer').classList.add('active');
      
      // Mark as read
      if (selectedEmail.unread) {
        markEmailAsRead(selectedEmail.id);
      }
    }

    // Close email viewer
    function closeEmailViewer() {
      document.getElementById('emailViewer').classList.remove('active');
      selectedEmail = null;
    }

    // Mark email as read
    async function markEmailAsRead(emailId) {
      try {
        await fetch(CFWORKER + '/email/mark-read', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username || currentUser.email.split('@')[0],
            emailId: emailId
          })
        });
        
        // Update UI
        const emailIndex = allEmails.findIndex(e => e.id === emailId);
        if (emailIndex !== -1) {
          allEmails[emailIndex].unread = false;
          displayEmails(allEmails);
        }
      } catch (error) {
        console.error('Mark read error:', error);
      }
    }

    // Email actions
    function replyToEmail() {
      if (!selectedEmail) return;
      
      openCompose();
      document.getElementById('modalTitle').textContent = 'Reply';
      
      // Add recipient
      toEmails = [selectedEmail.from];
      updateRecipientChips('to');
      
      // Add subject
      const subject = selectedEmail.subject.startsWith('Re:') ? 
        selectedEmail.subject : 
        'Re: ' + selectedEmail.subject;
      document.getElementById('subject').value = subject;
      
      // Add quoted original message
      const editor = document.getElementById('bodyEditor');
      editor.innerHTML = `
        <p><br></p>
        <p><br></p>
        <div style="border-left: 3px solid #d1d5db; padding-left: 16px; color: #6b7280;">
          <p><strong>On ${formatDate(selectedEmail.date)}, ${escapeHtml(selectedEmail.from)} wrote:</strong></p>
          ${selectedEmail.body}
        </div>
      `;
    }

    function forwardEmail() {
      if (!selectedEmail) return;
      
      openCompose();
      document.getElementById('modalTitle').textContent = 'Forward';
      
      // Add subject
      const subject = selectedEmail.subject.startsWith('Fwd:') ? 
        selectedEmail.subject : 
        'Fwd: ' + selectedEmail.subject;
      document.getElementById('subject').value = subject;
      
      // Add original message
      const editor = document.getElementById('bodyEditor');
      editor.innerHTML = `
        <p><br></p>
        <p><br></p>
        <div style="border-left: 3px solid #d1d5db; padding-left: 16px;">
          <p><strong>---------- Forwarded message ---------</strong></p>
          <p><strong>From:</strong> ${escapeHtml(selectedEmail.from)}</p>
          <p><strong>Date:</strong> ${formatDate(selectedEmail.date)}</p>
          <p><strong>Subject:</strong> ${escapeHtml(selectedEmail.subject)}</p>
          <p><br></p>
          ${selectedEmail.body}
        </div>
      `;
    }

    async function starEmail() {
      if (!selectedEmail) return;
      
      try {
        await fetch(CFWORKER + '/email/star', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username || currentUser.email.split('@')[0],
            emailId: selectedEmail.id,
            starred: !selectedEmail.starred
          })
        });
        
        selectedEmail.starred = !selectedEmail.starred;
        showStatus('Email ' + (selectedEmail.starred ? 'starred' : 'unstarred'), 'success');
      } catch (error) {
        console.error('Star error:', error);
      }
    }

    async function archiveEmail() {
      if (!selectedEmail) return;
      
      try {
        await fetch(CFWORKER + '/email/archive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username || currentUser.email.split('@')[0],
            emailId: selectedEmail.id
          })
        });
        
        closeEmailViewer();
        loadEmails();
        showStatus('Email archived', 'success');
      } catch (error) {
        console.error('Archive error:', error);
      }
    }

    async function deleteEmail() {
      if (!selectedEmail) return;
      
      if (!confirm('Are you sure you want to delete this email?')) return;
      
      try {
        await fetch(CFWORKER + '/email/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username || currentUser.email.split('@')[0],
            emailId: selectedEmail.id
          })
        });
        
        closeEmailViewer();
        loadEmails();
        showStatus('Email deleted', 'success');
      } catch (error) {
        console.error('Delete error:', error);
      }
    }

    // Toolbar actions
    function markAsRead() {
      showStatus('Feature coming soon!', 'info');
    }

    function deleteSelected() {
      showStatus('Feature coming soon!', 'info');
    }

    // Search
    function searchEmails() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      
      if (!query) {
        displayEmails(allEmails);
        return;
      }
      
      const filtered = allEmails.filter(email => 
        email.subject.toLowerCase().includes(query) ||
        email.from.toLowerCase().includes(query) ||
        (email.snippet && email.snippet.toLowerCase().includes(query))
      );
      
      displayEmails(filtered);
    }

    // Pagination
    function updatePagination(emailCount) {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(emailCount / emailsPerPage);
      
      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }
      
      pagination.style.display = 'flex';
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      
      const prevBtn = pagination.querySelector('button:first-child');
      const nextBtn = pagination.querySelector('button:last-child');
      
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
    }

    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        loadEmails();
      }
    }

    function nextPage() {
      currentPage++;
      loadEmails();
    }

    // Refresh
    function refreshEmails() {
      loadEmails();
      showStatus('Emails refreshed!', 'success');
      setTimeout(() => hideStatus(), 2000);
    }

    // Update inbox badge
    function updateInboxBadge(count) {
      document.getElementById('inboxBadge').textContent = count;
    }

    // Load drafts count
    async function loadDraftsCount() {
      if (!currentUser) {
        console.error('loadDraftsCount called but currentUser is null');
        return;
      }
      
      try {
        const response = await fetch(CFWORKER + '/email/drafts/count', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username || currentUser.email.split('@')[0]
          })
        });
        
        const data = await response.json();
        if (data.ok) {
          document.getElementById('draftsBadge').textContent = data.count || 0;
        }
      } catch (error) {
        console.error('Load drafts count error:', error);
      }
    }

    // Compose Modal
    function openCompose(draftId = null) {
      currentDraftId = draftId;
      document.getElementById('composeModal').classList.add('active');
      document.getElementById('bodyEditor').focus();
      
      if (draftId) {
        loadDraft(draftId);
      }
    }

    function closeCompose() {
      if (hasUnsavedChanges()) {
        if (!confirm('You have unsaved changes. Discard draft?')) {
          return;
        }
      }
      
      document.getElementById('composeModal').classList.remove('active');
      resetComposeForm();
    }

    function resetComposeForm() {
      document.getElementById('modalTitle').textContent = 'New Message';
      toEmails = [];
      ccEmails = [];
      bccEmails = [];
      attachments = [];
      currentDraftId = null;
      
      updateRecipientChips('to');
      updateRecipientChips('cc');
      updateRecipientChips('bcc');
      
      document.getElementById('subject').value = '';
      document.getElementById('bodyEditor').innerHTML = '';
      document.getElementById('attachmentList').innerHTML = '';
      
      document.getElementById('ccGroup').style.display = 'none';
      document.getElementById('bccGroup').style.display = 'none';
      
      hideStatus();
    }

    function hasUnsavedChanges() {
      return toEmails.length > 0 || 
             document.getElementById('subject').value ||
             document.getElementById('bodyEditor').textContent.trim();
    }

    // Toggle Cc/Bcc
    function toggleCcBcc() {
      const ccGroup = document.getElementById('ccGroup');
      const bccGroup = document.getElementById('bccGroup');
      
      if (ccGroup.style.display === 'none') {
        ccGroup.style.display = '';
        bccGroup.style.display = '';
      } else {
        ccGroup.style.display = 'none';
        bccGroup.style.display = 'none';
      }
    }

    // Handle recipient input
    function handleRecipientInput(event, type) {
      if (event.key === 'Enter' || event.key === ',' || event.key === ' ') {
        event.preventDefault();
        const input = event.target;
        const email = input.value.trim().replace(/,/g, '');
        
        if (email && isValidEmail(email)) {
          if (type === 'to' && !toEmails.includes(email)) {
            toEmails.push(email);
            updateRecipientChips('to');
          } else if (type === 'cc' && !ccEmails.includes(email)) {
            ccEmails.push(email);
            updateRecipientChips('cc');
          } else if (type === 'bcc' && !bccEmails.includes(email)) {
            bccEmails.push(email);
            updateRecipientChips('bcc');
          }
          
          input.value = '';
        }
      } else if (event.key === 'Backspace' && !event.target.value) {
        if (type === 'to' && toEmails.length > 0) {
          toEmails.pop();
          updateRecipientChips('to');
        } else if (type === 'cc' && ccEmails.length > 0) {
          ccEmails.pop();
          updateRecipientChips('cc');
        } else if (type === 'bcc' && bccEmails.length > 0) {
          bccEmails.pop();
          updateRecipientChips('bcc');
        }
      }
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function updateRecipientChips(type) {
      const emails = type === 'to' ? toEmails : (type === 'cc' ? ccEmails : bccEmails);
      const containerId = type + 'Container';
      const inputId = type + 'Input';
      
      const container = document.getElementById(containerId);
      const input = document.getElementById(inputId);
      
      // Clear container except input
      container.innerHTML = '';
      
      // Add chips
      emails.forEach((email, index) => {
        const chip = document.createElement('div');
        chip.className = 'email-chip';
        chip.innerHTML = `
          ${escapeHtml(email)}
          <span class="remove" onclick="removeRecipient('${type}', ${index})">√ó</span>
        `;
        container.appendChild(chip);
      });
      
      // Re-add input
      container.appendChild(input);
    }

    function removeRecipient(type, index) {
      if (type === 'to') {
        toEmails.splice(index, 1);
        updateRecipientChips('to');
      } else if (type === 'cc') {
        ccEmails.splice(index, 1);
        updateRecipientChips('cc');
      } else if (type === 'bcc') {
        bccEmails.splice(index, 1);
        updateRecipientChips('bcc');
      }
    }

    // Text formatting
    function formatText(command, value = null) {
      document.execCommand(command, false, value);
      document.getElementById('bodyEditor').focus();
    }

    function insertLink() {
      const url = prompt('Enter URL:');
      if (url) {
        document.execCommand('createLink', false, url);
        document.getElementById('bodyEditor').focus();
      }
    }

    function toggleColorPicker(type, event) {
      event.stopPropagation();
      currentColorType = type;
      const picker = document.getElementById('colorPicker');
      const btn = event.target.closest('.toolbar-btn');
      const rect = btn.getBoundingClientRect();
      
      picker.style.left = rect.left + 'px';
      picker.style.top = (rect.bottom + 4) + 'px';
      picker.classList.toggle('active');
    }

    function applyColor(color) {
      if (currentColorType === 'text') {
        document.execCommand('foreColor', false, color);
      } else {
        document.execCommand('backColor', false, color);
      }
      document.getElementById('colorPicker').classList.remove('active');
      document.getElementById('bodyEditor').focus();
    }

    function togglePresetMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('presetMenu');
      const btn = event.target.closest('.toolbar-btn');
      const rect = btn.getBoundingClientRect();
      
      menu.style.left = rect.left + 'px';
      menu.style.top = (rect.bottom + 4) + 'px';
      menu.classList.toggle('active');
    }

    // Preset templates
    function insertChildSafeKit() {
      const editor = document.getElementById('bodyEditor');
      editor.innerHTML = `
<p>Hi there,</p>

<p>I wanted to share an important resource with you - the <strong>Child Safe Kit</strong> app. This free app provides crucial safety information and tools to help protect your family.</p>

<p><strong>Download the Child Safe Kit app:</strong></p>

<p>
üì± <strong>Apple iPhone/iPad:</strong><br>
<a href="https://apps.apple.com/us/app/child-safe-kit/id1296310200" target="_blank" style="color: #3b82f6; text-decoration: none;">Download from App Store ‚Üí</a>
</p>

<p>
ü§ñ <strong>Android:</strong><br>
<a href="https://play.google.com/store/search?q=child%20safe%20kit&c=apps&hl=en_US" target="_blank" style="color: #3b82f6; text-decoration: none;">Download from Google Play ‚Üí</a>
</p>

<p>This app includes features like emergency contacts, safety checklists, and important information storage to keep your children safe.</p>

<p>Let me know if you have any questions!</p>

<p>Best regards,</p>
      `;
      
      document.getElementById('presetMenu').classList.remove('active');
      editor.focus();
    }

    function insertWillKit() {
      const editor = document.getElementById('bodyEditor');
      editor.innerHTML = `
<p>Hi there,</p>

<p>I'm pleased to share with you our comprehensive <strong>Will Kit</strong> guide. This document will help you understand the importance of estate planning and guide you through creating your will.</p>

<p><strong>üìÑ Will Kit PDF is attached to this email.</strong></p>

<p>Inside the Will Kit, you'll find:</p>
<ul>
  <li>Step-by-step instructions for creating a will</li>
  <li>Important considerations for estate planning</li>
  <li>Sample templates and forms</li>
  <li>Checklist to ensure nothing is overlooked</li>
</ul>

<p>Planning your estate is one of the most important steps you can take to protect your family's future. Please review the attached document carefully.</p>

<p>If you have any questions or would like to discuss your specific situation, feel free to reach out. I'm here to help!</p>

<p>Best regards,</p>
      `;
      
      document.getElementById('presetMenu').classList.remove('active');
      alert('üìé Note: Remember to attach willkit.pdf from your /email/ folder!');
      editor.focus();
    }

    function insertFollowUp() {
      const editor = document.getElementById('bodyEditor');
      editor.innerHTML = `
<p>Hi [Name],</p>

<p>I wanted to follow up on our recent conversation. I hope you've had time to consider the information I shared with you.</p>

<p>I'm here to answer any questions you might have and help you move forward with the best decision for you and your family.</p>

<p>Would you be available for a brief call this week? I have openings on [Day] at [Time] or [Day] at [Time].</p>

<p>Looking forward to hearing from you!</p>

<p>Best regards,</p>
      `;
      
      document.getElementById('presetMenu').classList.remove('active');
      editor.focus();
    }

    function insertMeeting() {
      const editor = document.getElementById('bodyEditor');
      editor.innerHTML = `
<p>Hi [Name],</p>

<p>I'd like to schedule a meeting with you to discuss [topic].</p>

<p><strong>Proposed Times:</strong></p>
<ul>
  <li>[Day, Date] at [Time]</li>
  <li>[Day, Date] at [Time]</li>
  <li>[Day, Date] at [Time]</li>
</ul>

<p>Please let me know which time works best for you, or suggest an alternative that fits your schedule.</p>

<p>The meeting will take approximately [duration] and we can connect via:</p>
<ul>
  <li>Phone: [Your Phone]</li>
  <li>Zoom: [Link]</li>
  <li>In-person: [Location]</li>
</ul>

<p>Looking forward to our conversation!</p>

<p>Best regards,</p>
      `;
      
      document.getElementById('presetMenu').classList.remove('active');
      editor.focus();
    }

    // File attachments
    function handleFileUpload() {
      const files = document.getElementById('fileInput').files;
      
      for (let file of files) {
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
          alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
          continue;
        }
        
        // Convert to base64
        const reader = new FileReader();
        reader.onload = function(e) {
          attachments.push({
            name: file.name,
            size: file.size,
            type: file.type,
            data: e.target.result.split(',')[1] // Remove data:type;base64, prefix
          });
          
          displayAttachments();
        };
        reader.readAsDataURL(file);
      }
      
      // Reset input
      document.getElementById('fileInput').value = '';
    }

    function displayAttachments() {
      const list = document.getElementById('attachmentList');
      
      list.innerHTML = attachments.map((file, index) => `
        <div class="attached-file">
          <div class="attached-file-icon">üìÑ</div>
          <div class="attached-file-info">
            <div class="attached-file-name">${escapeHtml(file.name)}</div>
            <div class="attached-file-size">${formatFileSize(file.size)}</div>
          </div>
          <div class="remove-attachment" onclick="removeAttachment(${index})">√ó</div>
        </div>
      `).join('');
    }

    function removeAttachment(index) {
      attachments.splice(index, 1);
      displayAttachments();
    }

    // Save draft
    async function saveDraft() {
      if (!currentUser) {
        showStatus('‚ùå Not authenticated. Please log in.', 'error');
        return;
      }
      
      const subject = document.getElementById('subject').value;
      const bodyContent = document.getElementById('bodyEditor').innerHTML;
      
      if (!toEmails.length && !subject && !bodyContent.trim()) {
        showStatus('Nothing to save', 'error');
        return;
      }
      
      try {
        const response = await fetch(CFWORKER + '/email/draft/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username || currentUser.email.split('@')[0],
            draftId: currentDraftId,
            to: toEmails,
            cc: ccEmails,
            bcc: bccEmails,
            subject: subject,
            body: bodyContent,
            attachments: attachments
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          currentDraftId = data.draftId;
          showStatus('‚úÖ Draft saved!', 'success');
          loadDraftsCount();
          setTimeout(() => hideStatus(), 2000);
        } else {
          showStatus('‚ùå Failed to save draft', 'error');
        }
      } catch (error) {
        console.error('Save draft error:', error);
        showStatus('‚ùå Error saving draft', 'error');
      }
    }

    async function loadDraft(draftId) {
      try {
        const response = await fetch(CFWORKER + '/email/draft/load', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: currentUser.username || currentUser.email.split('@')[0],
            draftId: draftId
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          const draft = data.draft;
          
          toEmails = draft.to || [];
          ccEmails = draft.cc || [];
          bccEmails = draft.bcc || [];
          
          updateRecipientChips('to');
          updateRecipientChips('cc');
          updateRecipientChips('bcc');
          
          document.getElementById('subject').value = draft.subject || '';
          document.getElementById('bodyEditor').innerHTML = draft.body || '';
          
          attachments = draft.attachments || [];
          displayAttachments();
          
          if (ccEmails.length || bccEmails.length) {
            toggleCcBcc();
          }
        }
      } catch (error) {
        console.error('Load draft error:', error);
      }
    }

    // Schedule email
    function scheduleEmail() {
      const datetime = prompt('Enter date and time (e.g., 2025-02-15 09:00):');
      if (datetime) {
        alert('Scheduled send feature coming soon! Your email will be sent at: ' + datetime);
      }
    }

    // Send email
    async function sendEmail() {
      console.log('Send button clicked!');
      
      if (!currentUser) {
        showStatus('‚ùå Not authenticated. Please log in.', 'error');
        return;
      }
      
      const sendBtn = document.getElementById('sendBtn');
      const subject = document.getElementById('subject').value;
      const bodyContent = document.getElementById('bodyEditor').innerHTML;
      const signature = document.getElementById('signaturePreview').innerHTML;
      
      // Capture any email still in input fields
      const toInputValue = document.getElementById('toInput').value.trim();
      if (toInputValue && isValidEmail(toInputValue) && !toEmails.includes(toInputValue)) {
        toEmails.push(toInputValue);
      }
      
      const ccInputValue = document.getElementById('ccInput').value.trim();
      if (ccInputValue && isValidEmail(ccInputValue) && !ccEmails.includes(ccInputValue)) {
        ccEmails.push(ccInputValue);
      }
      
      const bccInputValue = document.getElementById('bccInput').value.trim();
      if (bccInputValue && isValidEmail(bccInputValue) && !bccEmails.includes(bccInputValue)) {
        bccEmails.push(bccInputValue);
      }
      
      // Validate
      if (toEmails.length === 0 || !subject) {
        showStatus('‚ùå Please add at least one recipient and a subject', 'error');
        return;
      }
      
      // Check if body has content
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = bodyContent;
      const textContent = tempDiv.textContent || tempDiv.innerText || '';
      
      if (!textContent.trim()) {
        showStatus('‚ùå Please write a message', 'error');
        return;
      }
      
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      
      try {
        const username = currentUser.username || currentUser.email.split('@')[0];
        const fullHtml = bodyContent + signature;
        
        // Send to primary recipients
        let successCount = 0;
        
        for (const recipient of toEmails) {
          const response = await fetch(CFWORKER + '/email/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: username,
              to: recipient,
              cc: ccEmails.join(', '),
              bcc: bccEmails.join(', '),
              subject: subject,
              html: fullHtml,
              attachments: attachments
            })
          });
          
          const data = await response.json();
          
          if (!data.ok) {
            throw new Error(data.error || 'Failed to send email to ' + recipient);
          }
          
          successCount++;
        }
        
        showStatus(`‚úÖ Email sent successfully to ${successCount} recipient${successCount > 1 ? 's' : ''}!`, 'success');
        
        // Delete draft if exists
        if (currentDraftId) {
          await fetch(CFWORKER + '/email/draft/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: username,
              draftId: currentDraftId
            })
          });
        }
        
        setTimeout(() => {
          closeCompose();
          if (currentView === 'sent') {
            loadEmails();
          }
          loadDraftsCount();
        }, 2000);
        
      } catch (error) {
        console.error('Send error:', error);
        showStatus('‚ùå Error: ' + error.message, 'error');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Email';
      }
    }

    // Utility functions
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      
      // Less than 24 hours
      if (diff < 86400000) {
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      }
      
      // Less than 7 days
      if (diff < 604800000) {
        return date.toLocaleDateString('en-US', { weekday: 'short' });
      }
      
      // This year
      if (date.getFullYear() === now.getFullYear()) {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
      
      // Older
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function showStatus(message, type = 'info') {
      const status = document.getElementById('composeStatus');
      status.className = 'status ' + type;
      status.textContent = message;
      status.style.display = 'block';
    }

    function hideStatus() {
      const status = document.getElementById('composeStatus');
      status.style.display = 'none';
    }

    function downloadAttachment(attachmentId) {
      alert('Download attachment: ' + attachmentId);
    }

    // Close menus when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.preset-btn')) {
        document.getElementById('presetMenu').classList.remove('active');
      }
      if (!e.target.closest('.toolbar-btn[onclick*="Color"]')) {
        document.getElementById('colorPicker').classList.remove('active');
      }
    });

    // Close modal when clicking outside
    document.getElementById('composeModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeCompose();
      }
    });

    // Keyboard shortcuts
    document.getElementById('bodyEditor').addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'b') {
          e.preventDefault();
          formatText('bold');
        } else if (e.key === 'i') {
          e.preventDefault();
          formatText('italic');
        } else if (e.key === 'u') {
          e.preventDefault();
          formatText('underline');
        } else if (e.key === 's') {
          e.preventDefault();
          saveDraft();
        }
      }
    });

    // Global keyboard shortcut for compose
    document.addEventListener('keydown', function(e) {
      if (e.key === 'c' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
        openCompose();
      }
    });
  </script>
</body>
</html>
