<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADB - Agent Create Client Link</title>

  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="/config.js"></script>

  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b0f1a;color:#fff}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#121a2a;border:1px solid #22314f;border-radius:14px;padding:14px;margin:12px 0}
    input,button{font-size:16px;padding:12px;border-radius:12px;border:1px solid #2a3b60;background:#0e1524;color:#fff;width:100%}
    button{cursor:pointer;border:none}
    button.primary{background:#2b6cff;font-weight:900}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:220px}
    .small{font-size:13px;opacity:.8;line-height:1.35}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;word-break:break-all}
    iframe{width:100%;height:720px;border:1px solid #2a3b60;border-radius:12px;background:#fff}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h2 style="margin:0 0 10px 0">ADB Certificate - Create Client Link</h2>

    <div class="row">
      <input id="clientName" placeholder="Client Full Name (required)" />
      <input id="dob" placeholder="Date of Birth (MM/DD/YYYY)" />
    </div>

    <div class="row">
      <input id="address" placeholder="Street Address" />
      <input id="phone" placeholder="Phone" />
    </div>

    <div class="row">
      <input id="city" placeholder="City" />
      <input id="state" placeholder="State" />
      <input id="zip" placeholder="ZIP" />
    </div>

    <div class="row">
      <input id="beneficiary" placeholder="Beneficiary" />
      <input id="relationship" placeholder="Relationship to Insured" />
    </div>

    <input id="clientEmail" placeholder="Client Email (optional - for PDF delivery)" />

    <hr style="border:0;border-top:1px solid #22314f;margin:14px 0">

    <div class="small" style="margin-bottom:10px">
      <b>Agent:</b> <span id="agentNameDisplay">Loading...</span>
    </div>

    <div class="row">
      <button id="previewBtn">Preview PDF</button>
      <button id="createBtn" class="primary">Create Client Signing Link</button>
    </div>

    <div id="status" class="small" style="margin-top:10px"></div>

    <div id="linkWrap" style="display:none;margin-top:10px">
      <div class="small"><b>Send this link to CLIENT to sign:</b></div>
      <div id="clientLinkOut" class="mono" style="background:#0e1524;border:1px solid #2a3b60;border-radius:12px;padding:12px;margin-top:8px"></div>
      <div class="row" style="margin-top:10px">
        <button id="copyClientBtn">Copy Client Link</button>
        <button id="openClientBtn">Open Client Link</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="small"><b>PDF Preview</b></div>
    <div style="margin-top:10px">
      <iframe id="pdfFrame" title="PDF Preview"></iframe>
    </div>
  </div>

</div>

<script>
// Global agent name (populated on load)
let AGENT_NAME = 'Unknown Agent';

// API URLs - defined FIRST so they're available
const WORKER_BASE = typeof CFWORKER !== 'undefined' ? CFWORKER : 'https://closing-coalition-api.thomaslancheros06.workers.dev';
const ADB_API_URL = `${WORKER_BASE}/adb`;
const ME_API_URL = `${WORKER_BASE}/me`;
const PDF_URL = "/ADB/ADB.pdf";

// Check authentication on page load (optional - won't force login)
(async function() {
  try {
    // Try to get token from storage
    const token = localStorage.getItem('cc_token') || 
                  localStorage.getItem('token') || 
                  localStorage.getItem('sessionToken');
    
    if (token) {
      // Token exists, try to verify and get username
      try {
        const res = await fetch(ME_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        
        const data = await res.json();
        
        if (res.ok && data.ok) {
          // Token valid, get user info
          const user = data.user || data.profile || data.data || data;
          AGENT_NAME = user.username || user.name || user.adminEmail || '';
          
          if (AGENT_NAME) {
            agentNameDisplay.textContent = AGENT_NAME;
          }
        } else {
          // Token invalid, clear it but don't redirect
          localStorage.removeItem('cc_token');
          localStorage.removeItem('token');
          localStorage.removeItem('sessionToken');
          agentNameDisplay.textContent = 'Not logged in';
        }
      } catch (err) {
        console.error('Auth check failed:', err);
        agentNameDisplay.textContent = 'Not logged in';
      }
    } else {
      // No token, that's fine - just show not logged in
      agentNameDisplay.textContent = 'Not logged in';
    }
  } catch (err) {
    console.error('Page load error:', err);
  }
})();

const FIELD_CORDS = {
  NAME_CORDS:           { x: 58,  y: 455, size: 13 },
  DOB_CORDS:            { x: 340, y: 455, size: 12 },
  PHONE_CORDS:          { x: 464, y: 457, size: 12 },
  ADDRESS_CORDS:        { x: 57,  y: 421, size: 12 },
  CITY_CORDS:           { x: 276, y: 420, size: 12 },
  STATE_CORDS:          { x: 451, y: 421, size: 12 },
  ZIP_CORDS:            { x: 491, y: 421, size: 12 },
  BENEFICIARY_CORDS:    { x: 56,  y: 386, size: 12 },
  REL_CORDS:            { x: 318, y: 386, size: 12 },
  INSURED_NAME_2:       { x: 56,  y: 88, size: 12 },
  INSURED_DOB_2:        { x: 317, y: 90, size: 12 },
  AGENT_NAME_2:         { x: 317, y: 52, size: 12 },
};

function tokenGen(len=22){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789";
  let out="";
  crypto.getRandomValues(new Uint8Array(len)).forEach(n=> out += chars[n % chars.length]);
  return out;
}

async function postJSON(url, payload){
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const json = await res.json().catch(()=>({}));
  if (!res.ok || json.ok === false) throw new Error(json.error || `Request failed (${res.status})`);
  return json;
}

async function loadPdfBytes(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("Failed to load ADB.pdf");
  return new Uint8Array(await res.arrayBuffer());
}

async function buildFilledPdf(data){
  const { PDFDocument, StandardFonts, rgb } = PDFLib;
  const bytes = await loadPdfBytes(PDF_URL);
  const pdfDoc = await PDFDocument.load(bytes);
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const page = pdfDoc.getPages()[0];

  // Format date helper - converts any date to MM/DD/YYYY
  const formatDate = (dateStr) => {
    if (!dateStr) return '';
    // If already in MM/DD/YYYY format, return as-is
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return dateStr;
    
    // Parse ISO timestamp or other formats
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr; // Invalid date, return original
    
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const year = date.getFullYear();
    return `${month}/${day}/${year}`;
  };

  const drawText = (cords, text) => {
    if(!text) return;
    page.drawText(String(text), {
      x: cords.x, y: cords.y,
      size: cords.size || 12,
      font,
      color: rgb(0,0,0)
    });
  };

  drawText(FIELD_CORDS.NAME_CORDS, data.clientName);
  drawText(FIELD_CORDS.DOB_CORDS, formatDate(data.dob));
  drawText(FIELD_CORDS.PHONE_CORDS, data.phone);
  drawText(FIELD_CORDS.ADDRESS_CORDS, data.address);
  drawText(FIELD_CORDS.CITY_CORDS, data.city);
  drawText(FIELD_CORDS.STATE_CORDS, data.state);
  drawText(FIELD_CORDS.ZIP_CORDS, data.zip);
  drawText(FIELD_CORDS.BENEFICIARY_CORDS, data.beneficiary);
  drawText(FIELD_CORDS.REL_CORDS, data.relationship);
  drawText(FIELD_CORDS.INSURED_NAME_2, data.clientName);
  drawText(FIELD_CORDS.INSURED_DOB_2, formatDate(data.dob));
  drawText(FIELD_CORDS.AGENT_NAME_2, data.agentName);

  return await pdfDoc.save();
}

function blobUrlFromBytes(bytes){
  const blob = new Blob([bytes], { type:"application/pdf" });
  return URL.createObjectURL(blob);
}

function getFormData(){
  return {
    clientName: clientName.value.trim(),
    dob: dob.value.trim(),
    address: address.value.trim(),
    phone: phone.value.trim(),
    city: city.value.trim(),
    state: state.value.trim(),
    zip: zip.value.trim(),
    beneficiary: beneficiary.value.trim(),
    relationship: relationship.value.trim(),
    clientEmail: clientEmail.value.trim(),
    agentName: AGENT_NAME,
  };
}

previewBtn.addEventListener("click", async ()=>{
  try{
    const data = getFormData();
    if(!data.clientName) throw new Error("Client Name required to preview.");
    status.textContent = "Building preview PDF‚Ä¶";
    const pdfBytes = await buildFilledPdf(data);
    pdfFrame.src = blobUrlFromBytes(pdfBytes);
    status.textContent = "‚úÖ Preview ready.";
  } catch(err){
    status.textContent = "‚ùå Preview error: " + err.message;
  }
});

createBtn.addEventListener("click", async ()=>{
  try{
    // Check if logged in
    if (!AGENT_NAME || AGENT_NAME === 'Unknown Agent' || AGENT_NAME === 'Not logged in') {
      alert('Please log in first to create certificates.');
      window.location.href = '/login.html';
      return;
    }

    const data = getFormData();
    if(!data.clientName) throw new Error("Client Name required.");

    status.textContent = "Saving to database‚Ä¶";
    createBtn.disabled = true;

    const token = tokenGen();

    const payload = {
      action: "createToken",
      token,
      agentName: data.agentName,
      clientName: data.clientName,
      dob: data.dob,
      address: data.address,
      phone: data.phone,
      city: data.city,
      state: data.state,
      zip: data.zip,
      beneficiary: data.beneficiary,
      relationship: data.relationship,
      clientEmail: data.clientEmail
    };

    console.log('Sending payload:', payload);
    
    try {
      const response = await postJSON(ADB_API_URL, payload);
      console.log('Server response:', response);

      const clientLink = `https://www.nf-financial.life/ADB/?adb=${encodeURIComponent(token)}`;

      clientLinkOut.textContent = clientLink;
      linkWrap.style.display = "block";

      copyClientBtn.onclick = async ()=> {
        await navigator.clipboard.writeText(clientLink);
        status.textContent = "‚úÖ Copied client link.";
      };
      openClientBtn.onclick = ()=> window.open(clientLink, "_blank");

      status.textContent = "‚úÖ Link created! Send to client to sign.";
      
    } catch (apiErr) {
      // Check if this is an OAuth authorization error
      const errMsg = apiErr.message || apiErr.toString() || '';
      if (errMsg.includes('500') || errMsg.includes('Authorization') || errMsg.includes('Proxy error')) {
        status.textContent = "üîê Authorization needed...";
        
        // Open Google Apps Script in popup for OAuth
        const gasUrl = ADB_API_URL.replace('/adb', ''); // Get worker base
        const scriptUrl = `https://script.google.com/macros/s/AKfycbz7y1cRuvf6yM-bXY2UFu4TrgUhNgxEdzh0lg0wo5FCbLGT_UVK1SoBwzy6Auuro_Uk-Q/exec`;
        
        const authPopup = window.open(
          scriptUrl + '?action=authorize',
          'OAuth Authorization',
          'width=600,height=700,left=100,top=100'
        );
        
        if (!authPopup) {
          alert('Please allow popups for this site to authorize the application.');
          throw apiErr;
        }
        
        // Wait for popup to close (user completed auth)
        const checkPopup = setInterval(async () => {
          if (authPopup.closed) {
            clearInterval(checkPopup);
            status.textContent = "Retrying after authorization...";
            
            // Wait a second, then retry the request
            setTimeout(async () => {
              try {
                const retryResponse = await postJSON(ADB_API_URL, payload);
                console.log('Retry response:', retryResponse);
                
                const clientLink = `https://www.nf-financial.life/ADB/?adb=${encodeURIComponent(token)}`;
                clientLinkOut.textContent = clientLink;
                linkWrap.style.display = "block";
                
                copyClientBtn.onclick = async ()=> {
                  await navigator.clipboard.writeText(clientLink);
                  status.textContent = "‚úÖ Copied client link.";
                };
                openClientBtn.onclick = ()=> window.open(clientLink, "_blank");
                
                status.textContent = "‚úÖ Link created! Send to client to sign.";
                createBtn.disabled = false;
                
              } catch (retryErr) {
                status.textContent = "‚ùå Still failed. Please contact support.";
                console.error('Retry failed:', retryErr);
                createBtn.disabled = false;
              }
            }, 1000);
          }
        }, 500);
        
        return; // Don't throw, we're handling it
      }
      
      throw apiErr;
    }

  } catch(err){
    console.error('Error details:', err);
    status.textContent = "‚ùå Error: " + err.message;
  } finally {
    if (!status.textContent.includes('Authorization needed')) {
      createBtn.disabled = false;
    }
  }
});
</script>
</body>
</html>
